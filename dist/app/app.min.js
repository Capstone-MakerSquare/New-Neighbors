var details = angular.module('myApp.details', []);

details.controller('detailsController', ['Details', 'Map', function (Details, Map){
  var detail = this;
  detail.markers = [];
  detail.selectedCategory = undefined;
  detail.currentSpotsToDisplay = [];

  detail.currentNeighborhood = Details.currentNeighborhood;

  // State flags to determine active tab
  // Amenities is open by fault
  detail.tabs = [1,0,0];    //[amenities, attractions, charts]

  // console.log('detailsController says: This is where you print from:', detail.currentNeighborhood.services);

  detail.displayMarkers = function(place) {
    var icon = Map.getIcon();
    // console.log('detail.currentNeighborhood.attractions', detail.currentNeighborhood.attractions);
    // console.log('detail.currentNeighborhood.services', detail.currentNeighborhood.services);
    // console.log('details.currentSpotsToDisplay:', detail.currentSpotsToDisplay);

    //clear out current markers
    Map.clearMarkers(Details.currentMarkers);

    for (var i = 0; i < place.length; i++) {
      var coordinates = {
        latitude: place[i].geometry.location.lat,
        longitude: place[i].geometry.location.lng
      };
      var tuple = Map.dropMarker(coordinates, place[i].name, place[i], icon, 'amenities_attractions');
      //[marker, infowindow]
      detail.markers.push(tuple[0]);

      place[i].marker = tuple[0]; place[i].infowindow = tuple[1];
    }
    for (var j = 0; j < detail.markers.length; j++){
      Details.currentMarkers.push(detail.markers[j]);
    }
    // console.log("detail.displayMarkers", place)
  };


  //----------------------------------------------------------------------------------
  //to expand and collapse icons section
  detail.isCollapsed = true;
  detail.moreLess = '+ More';
  detail.expandCollapse = function() {
    if (detail.moreLess === '+ More') {
      detail.moreLess = '- Less';
    } else if (detail.moreLess === '- Less') {
      detail.moreLess = '+ More';
    }
    detail.isCollapsed = !detail.isCollapsed;
  };
  //----------------------------------------------------------------------------------


  //----------------------------------------------------------------------------------
  // populates slideshow with Instagram photos
  // Todo: dupe of main.populatePictures in mainCtrl.js?
  // Todo: Check sizes?
  detail.populatePictures = function(){
    var pictures = [];
    detail.currentNeighborhood.instagram.forEach(function (obj) {
      pictures.push([obj.image, obj.userLink]);
    });
    return pictures;
  };

  // detail.picturesArr = detail.populatePictures()

  //remove
  // console.log('detailsController says: picturesArr:', detail.picturesArr);

  //----------------------------------------------------------------------------------

  //----------------------------------------------------------------------------------
   // sets selected category on click
   detail.selectCategory = function(index) {
     // console.log("selected category fn called with index", index)
      detail.selectedCategory = index;

    // console.log(category, "attraction index:", detail.selectedAttractionCategory, "service index:", detail.selectedServiceCategory);
  };

  //----------------------------------------------------------------------------------

  //HELPERS
  //----------------------------------------------------------------------------------
   // sets current attractions to spots array for ng-repeat directive
   detail.displayAmenitiesOrAttractions = function(spotsArray) {
    // console.log('Selected Spots:', spotsArray);
    detail.currentSpotsToDisplay = spotsArray;
  };

  //----------------------------------------------------------------------------------
    // allows info window to be open and closed on click
    detail.toggleTooltip = function (spot) {
      // console.log('Tool tip toggle for spot:', spot);
      Map.toggleInfoWindow(spot.infowindow, spot.marker);
    };

  //----------------------------------------------------------------------------------
    detail.getAmenitiesIcon = function(amenity) {
      // console.log('getAmenitiesIcon says: amenity:',amenity);
      return './assets/images/Amenities/'+amenity.displayName+'.png';
    };

  //----------------------------------------------------------------------------------
    detail.getAttractionsIcon = function(attraction) {
      // console.log('getAttractionsIcon says: attraction:',attraction);
      return './assets/images/Attractions/'+attraction.displayName+'.png';
    };

  //----------------------------------------------------------------------------------
   // State flags to determine active tab on click
    detail.stateSwitch = function(currState) {
      switch(currState) {
        case 'amenities': detail.tabs = [1,0,0];
                          break;
        case 'attractions': detail.tabs = [0,1,0];
                            break;
        case 'charts': detail.tabs = [0,0,1];
                           break;
        default: break;
      }
      // console.log('stateSwitch says:',detail.tabs);
    };
}]);

var mapMod = angular.module('myApp.map',[]);

mapMod.directive('map', ['Map', '$scope', function (Map, $scope) {

  var link = function(scope) {
    var centerUS = {
      latitude: 38.5,
      longitude: -96
    };
    Map.initialize(centerUS);
    Map.panAndFocusDestination(Map.targetLocation);
    setTimeout(function () { $scope.$apply(); }, 500);
  }

  return {
    restrict: 'E',
    replace: true,
    templateUrl: 'app/map/mapTemplate.html',
    controller: 'MainController',
    controllerAs: 'main',
    scope: false,
    link: link  //'link' is a keyword that invokes once the directive is done loading
  };
}]);


var searchForm = angular.module('myApp.searchForm', []);
searchForm.directive('searchform', [function() {

  return {
    restrict: 'E',
    replace: true,
    templateUrl: 'app/searchForm/searchFormTemplate.html'
  };
}]);

var filter = angular.module('myApp.filter', []);
filter.directive('filters', [function() {

  return {
    restrict: 'E',
    replace: true,
    templateUrl: 'app/filter/filterTemplate.html'
  };
}]);
var thumbnails = angular.module('myApp.thumbnails', []);
thumbnails.directive('thumbnail', [function() {

  return {
    restrict: 'E',
    replace: true,
    templateUrl: 'app/thumbnails/thumbnailsTemplate.html'
  };
}]);
app.controller('MainController', ['Map', 'ServerApi', '$state', 'Details', 'Charts', '$anchorScroll', '$location', '$scope', '$timeout', function (Map, ServerApi, $state, Details, Charts, $anchorScroll, $location, $scope, $timeout){

  var main = this;
  main.picturesArr = [];
  main.isCollapsed = false;
  main.neighborhoodsObj = {}; //this is the response from the server

  main.searchInfo = {}; // JSON obj to send to server
  main.searchInfo.address = '';
  main.searchInfo.buyOrRent = 'rent';
  main.searchInfo.bedrooms = '1';
  main.searchInfo.bathrooms = '1';

  main.filter = {}; //object to collect filter specific information
  main.filter.maxRent = 8000;
  main.filter.commuteTime = 45;
  main.filter.commuteDistance = 30;

  main.filter.maxBuy = 5000000;

  main.filteredNeighborhoodArray = [];
  main.serverResponse = {};
  main.filterType = 'estimateLow';
  main.currentNeighborhood = { name: 'default' };
  main.loading = false;

  main.serviceObj = {};
  main.attractionObj = {};

  main.coordinates = {
      latitude: 38.5,
      longitude: -98.5
  };

  main.priceRange = '';      //stores the current price range for the selected neighborhood
  main.buyPrice = {};

  //unscoped local variables
  var autocomplete;

  //----------------------------------------------------------------------------------
  // Function to flatten the object so that the array can be sorted by a parameter
  // Input: neighborhoodsObj
  // Output: flattened array of objects
  main.getPriceString = function (neighborhood) {
    var obj = {};
    if(main.searchInfo.buyOrRent === 'rent') {
      if(!neighborhood.rentEstimate) {
        obj.title = 'Rent Estimate';
        obj.price = 'Not Available';
        return obj;
      }
      obj.title = 'Rent Estimate';
      obj.price = (neighborhood.rentEstimate.estimateLow) ? '$' + neighborhood.rentEstimate.estimateLow.toLocaleString() + ' - ' + '$' + neighborhood.rentEstimate.estimateHigh.toLocaleString() : 'Not Available';
    } else {
        if(!main.buyPrice[neighborhood.name].priceStr) {
          obj.title = 'Home Price';
          obj.price = 'Not Available';
          return obj;
        }
        obj.title = main.buyPrice[neighborhood.name].housetype;
        obj.price = main.buyPrice[neighborhood.name].priceStr;
      }
    return obj;
  };

  main.orderPrice = function(obj) {
    if(main.searchInfo.buyOrRent === 'rent') {
      if (obj.rentEstimate) {
        return obj.rentEstimate.estimateLow;
      } else {
        return "Price Not Available";
      }
    } else {
      return main.buyPrice[obj.name].priceNum;
    }
  };

  main.orderByArray = function(neighborhoods){
    var arr = [];
    for (var i = 0; i < neighborhoods.length; i++) {
      if(neighborhoods[i].name==='Downtown') {
        neighborhoods[i].name = neighborhoods[i].name + ' ' + neighborhoods[i].city;
      }
      arr.push({
          name: neighborhoods[i].name,
          commuteTime: (neighborhoods[i].commuteInfo && neighborhoods[i].commuteInfo.commuteTime) ? neighborhoods[i].commuteInfo.commuteTime : 'Not Available',
          commuteDistance: (neighborhoods[i].commuteInfo && neighborhoods[i].commuteInfo.commuteDistance) ? neighborhoods[i].commuteInfo.commuteDistance : 'Not Available',
          estimateLow: neighborhoods[i].rentEstimate ? neighborhoods[i].rentEstimate.estimateLow : 'Not Available',
          estimateHigh: neighborhoods[i].rentEstimate ? neighborhoods[i].rentEstimate.estimateHigh : 'Not Available',
          googlePics: neighborhoods[i].googlePics,
          coordinates: {latitude: neighborhoods[i].latitude, longitude: neighborhoods[i].longitude},
          demography: neighborhoods[i].demographics,
          priceString : main.getPriceString(neighborhoods[i]),
          orderPrice: main.orderPrice(neighborhoods[i])
      });
    }
    return arr;
  };

//Function to get the purchase prices for homes
  main.getBuyPrice  = function(arr) {
    var priceData;
    var dataInfo;
    var temp = {};
      temp.priceNum;
      temp.priceStr;
            //item.demography.pages[0].page[0].tables[0].table[0].data[0].attribute[3].values[0]
        ////.city[0].value[0]._
    arr.forEach( function(item) {
      priceData = {};
      dataInfo = [,];
      temp = {
        housetype: 'House Purchase Estimate',
        priceStr: 'Data Not Available',
        priceNum: 100000000
        };
      if (main.searchInfo.buyOrRent === 'rent') {
        temp.housetype = 'rent selected';
        temp.priceStr = 'rent selected';
      } else if (item.demographics &&
        item.demographics.pages &&
        item.demographics.pages[0] &&
        item.demographics.pages[0].page &&
        item.demographics.pages[0].page[0] &&
        item.demographics.pages[0].page[0].tables &&
        item.demographics.pages[0].page[0].tables[0] &&
        item.demographics.pages[0].page[0].tables[0].table &&
        item.demographics.pages[0].page[0].tables[0].table[0] &&
        item.demographics.pages[0].page[0].tables[0].table[0].data &&
        item.demographics.pages[0].page[0].tables[0].table[0].data[0] &&
        item.demographics.pages[0].page[0].tables[0].table[0].data[0].attribute) {

        priceData = item.demographics.pages[0].page[0].tables[0].table[0].data[0].attribute;

        dataInfo[1] = 'city';

        if (main.searchInfo.bedrooms === '2') {
          temp.housetype = '2-Bedroom Home';
          dataInfo[0] = 3
        } else if (main.searchInfo.bedrooms === '3') {
          temp.housetype = '3-Bedroom Home';
          dataInfo[0] = 4;
        } else if (main.searchInfo.bedrooms === '4') {
          temp.housetype = '4-Bedroom Home';
          dataInfo[0] = 5;
        } else if (main.searchInfo.buyOrRent === 'buy') {
          temp.housetype = 'Single Family Home';
          dataInfo[0] = 1;
        }
        if (priceData[dataInfo[0]] && priceData[dataInfo[0]].values && priceData[dataInfo[0]].values[0]) {
          if (priceData[dataInfo[0]].values[0].neighborhood) {
            dataInfo[1] = 'neighborhood';
          }
        }
        if (priceData[dataInfo[0]] &&
          priceData[dataInfo[0]].values &&
          priceData[dataInfo[0]].values[0] &&
          priceData[dataInfo[0]].values[0][dataInfo[1]] &&
          priceData[dataInfo[0]].values[0][dataInfo[1]][0] &&
          priceData[dataInfo[0]].values[0][dataInfo[1]][0].value &&
          priceData[dataInfo[0]].values[0][dataInfo[1]][0].value[0] &&
          priceData[dataInfo[0]].values[0][dataInfo[1]][0].value[0]._) {
            temp.priceNum = parseInt(priceData[dataInfo[0]].values[0][dataInfo[1]][0].value[0]._);
            temp.priceStr = '$' + temp.priceNum.toLocaleString();
        }
      }
      main.buyPrice[item.name] = temp;
    });
  };

  //Function to set the selected type of housing to 'rent'
  main.setValueRent = function() {
    main.searchInfo.buyOrRent = 'rent';
  };

  //Function to set the selected type of housing to 'buy'
  main.setValueBuy = function() {
    main.searchInfo.buyOrRent = 'buy';
  };


  //----------------------------------------------------------------------------------
  //Function to set up autocomplete feature for the search field
  main.autoCompleteInit = function () {
    var input = document.getElementById('place-search');
    var options = { types: [] };   // Todo: limit to [geocode] per https://developers.google.com/maps/documentation/javascript/places-autocomplete ?
    autocomplete = new google.maps.places.Autocomplete(input, options);

    //listener to listen to a place change
    autocomplete.addListener('place_changed', function() {
      var place = autocomplete.getPlace();
      // console.log('mainCtrl.js says: Place changed. Place:',place);
      if(main.searchInfo.address.length > 0 || place.formatted_address) {
        main.searchInfo.address = place.formatted_address || main.searchInfo.address;
      }
    });
  };

  //----------------------------------------------------------------------------------
  //Function to fetch address and validate it
  main.submitAddress = function() {
    // $state.go('main.results');
    main.loading = true;
    main.filteredNeighborhoodArray = [];
    requestNeighborhoods();
    Map.panAndFocusDestination(main.searchInfo.address);
    Charts.clearCharts();
  };

  //Rerouters
  main.getResults = function() {
    $state.go('main.results');
  }
  main.gotoLanding = function() {
    $state.go('landing');
  }

  //----------------------------------------------------------------------------------
  // Function to make an API request for neighborhoods
  var requestNeighborhoods = function() {
    ServerApi.submit(main.searchInfo)
    .then(function(data) {
      main.loading = false;
      main.serverResponse = data;
      main.neighborhoods = Object.keys(data).map(function(key) { return data[key]; });  //converts object of objects to array of objects

      //remove
      // console.log('requestNeighborhoods says: main.neighborhoods:',main.neighborhoods);

      main.attractionObj = Details.createPlacesObj(main.neighborhoods, Details.attractionDict);
      main.serviceObj = Details.createPlacesObj(main.neighborhoods, Details.serviceDict);

      //remove
      // console.log('requestNeighborhoods says: main.serviceObj:',main.serviceObj);

      main.getBuyPrice(main.neighborhoods);
      main.neighborhoodArray = main.orderByArray(main.neighborhoods);
      main.filterNeighborhoods();

      main.markNeighborhoods();

    });
  };

  //----------------------------------------------------------------------------------
  // Function to filter neighborhoods by user's filter options
  main.filterNeighborhoods = function() {
    main.filteredNeighborhoodArray = main.neighborhoodArray.filter(function(obj) {
      return !(
        (main.searchInfo.buyOrRent === 'rent' && main.filter.maxRent < obj.estimateLow) ||
        (main.searchInfo.buyOrRent === 'buy' && main.filter.maxBuy < obj.orderPrice) ||
        (main.filter.communuteTime < obj.commuteTime) ||
        (main.filter.commuteDistance < obj.commuteDistance) );
    });
  };

  //----------------------------------------------------------------------------------
  // Function to filter neighborhoods by user's filter options
  main.markNeighborhoods = function() {
    for (var i = 0; i < main.neighborhoodArray.length; i++) {
      Details.neighborhoodMarkers.push(main.dropNeighborhoodMarker(main.neighborhoodArray[i].coordinates, main.neighborhoodArray[i].name, main.neighborhoodArray[i]));
    }
  };

  //----------------------------------------------------------------------------------
  //Drop a marker with a link to be clicked
  main.dropNeighborhoodMarker = function (coordinates, title, neighborhoodObj) {
    var icon = {
      url: "assets/images/Loading/housepurplewhite.png",
      size: new google.maps.Size(5.3*8, 13*8),
      origin: new google.maps.Point(0, 0),
      anchor: new google.maps.Point(10, 30),
      scaledSize: new google.maps.Size(5.3*4, 13*4)
    };

    var marker = Map.dropMarker(coordinates, title, title, icon, 'neighborhood')[0];


    marker.addListener('click', function() {
      console.log('neighborhood clicked:', neighborhoodObj);
      if(neighborhoodObj.name === main.currentNeighborhood.name) { return; }

      main.selectNeighborhood(neighborhoodObj)
      // console.log('neighborhoodObj:',neighborhoodObj);
      // console.log('main.currneigh:',main.currentNeighborhood);
    });

    return marker;
  };



  //----------------------------------------------------------------------------------
  //Function to move the page

  main.goToAnchor = function(anchorId) {
    // set the location.hash to the id of
    // the element you wish to scroll to.
    $location.hash(anchorId);

    // call $anchorScroll()
    $anchorScroll();
  };

  //----------------------------------------------------------------------------------
  // Helper functions - GOOGLE MAPS

  //----------------------------------------------------------------------------------
  //Function to initialize and draw the map, centering on the the center of the U.S.
  main.initMap = function() {
    console.log("main.initMap")
    var centerUS = {
      latitude: 38.5,
      longitude: -96
    };
    //test coordinates
    Map.initialize(centerUS);
  };

  //----------------------------------------------------------------------------------
  //Function to add a marker on the map
  main.addMarker = function (coordinates, title) {
    title = 'Test marker' || title;
    Map.dropMarker(coordinates, title);
  };

  //----------------------------------------------------------------------------------
  //Function to test new methods defined in mapService
  //remove
  main.testMap = function() {
    console.log('mainCtrl.js says: testMap called');  //make the submit button work
    // Map.panAndFocus(main.coordinates);
    // Map.dropMarker(main.coordinates);
  };

  //----------------------------------------------------------------------------------
  //Function to map neighborhood data
  main.mapCurrentNeighborhood = function (neighborhood) {
    Details.currentNeighborhood = neighborhood;
    Details.currentNeighborhood.services = main.serviceObj[neighborhood.name];
    Details.currentNeighborhood.attractions = main.attractionObj[neighborhood.name];


    for (var service in Details.currentNeighborhood.services){
      var serviceArray = Details.currentNeighborhood.services[service];
      serviceArray.forEach(function(serviceSpot) {
        if(service === 'grocery_or_supermarket') { serviceSpot.displayName = 'grocery'; }
        else { serviceSpot.displayName = service.replace("_", " ");}
      });
    }

    for (var place in Details.currentNeighborhood.attractions){
      Details.currentNeighborhood.attractions[place][0].displayName = place.replace("_", " ");
    }

    //remove
    // console.log("mapCurrentNeighborhood says: Details.currentNeighborhood:", Details.currentNeighborhood);
  }

  //----------------------------------------------------------------------------------
  //Function to drop a circle + marker on a selected neighborhood
  main.selectNeighborhood = function (neighborhood) {
    // console.log('mainCtrl.js says: selected Neighborhood: ', neighborhood);
    main.populatePictures(neighborhood);
    main.mapCurrentNeighborhood(neighborhood);
    main.priceRange = neighborhood.priceString;
    main.currentNeighborhood = neighborhood;

    // console.log('select neigh bor hood current',  main.currentNeighborhood)

    //remove
    // console.log('selectNeighborhood says: main.serverResponse:',main.serverResponse);
    // console.log('selectNeighborhood', Details.currentNeighborhood);
    // Todo: remove setTimeout.  Seriously, it's not even $Timeout.

    $state.go('main.results');
    setTimeout(function() {
      $state.go('main.details.services');

      Charts.barChartData(neighborhood);
      Charts.pieChartData(neighborhood);
      Charts.createStrings(neighborhood);
      Map.panAndFocus(neighborhood.coordinates, 13);
      Map.drawCircle(neighborhood.coordinates, 2000);
    }, 200)
  };

  //----------------------------------------------------------------------------------
  // googlePics map
  main.populatePictures = function(hood){
    main.picturesArr = [];
    if (!hood.googlePics) {
      console.log("No Pictures Found");
    }
    hood.googlePics.forEach(function (obj) {
      main.picturesArr.push([obj.image, obj.userLink]);
    });
    // console.log('detailsController says: picturesArr:', main.picturesArr);
  }


  //----------------------------------------------------------------------------------
  // Initialization functions
  main.initialize = function() {
    Map.initialize();
    main.submitAddress();
  }

  main.autoCompleteInitialize = function() {
    setTimeout(main.autoCompleteInit,100);
  }

}]);












angular.module('myApp.charts', [])

.controller('chartsController', ['$scope', 'Charts', function ($scope, Charts){

  var chart = this;
  //the display text for the Statistics view to the left of the bar chart
  chart.incomeString = 'Not Available';
  chart.sqftString = 'Not Available';
  chart.yearBuiltString = 'Not Available';

  //initializes it so that the pie and bar chart won't run unless there is information
  chart.barChart = false;
  chart.pieChart = false;

  chart.setStrings = function () {
    var demographicsObj = Charts.getDemographicsObj();
    if(Object.keys(demographicsObj).length > 0) {
      chart.incomeString = demographicsObj.incomeString || chart.incomeString;
      chart.ageString = demographicsObj.ageString || chart.ageString;
      chart.householdPopString = demographicsObj.householdPopString || chart.householdPopString;
    }
  };

  chart.setFlags = function () {
    var tuple = Charts.getFlags();    //[barchart, piechart]
    if(tuple[0]) { chart.barChart = true; }
    if(tuple[1]) { chart.pieChart = true; }
  }

  var options = {
    useEasing:true,
    useGrouping: true,
    separator:',',
    decimal:'.',
    prefix:'',
    suffix:''
  }

  chart.countup = function() {
    var flags = [1,1,1];

    if(chart.incomeString === 'Not Available') { flags[0] = 0; }
    if(chart.sqftString === 'Not Available') { flags[1] = 0; }
    if(chart.yearBuiltString === 'Not Available') { flags[2] = 0; }

    setTimeout(function() {
      if(flags[0]) {
        var c1 = new CountUp('countup1', 0, parseInt(chart.incomeString), 0, 2.5, options);
        c1.start();
      }
      if(flags[1]) {
        var c2 = new CountUp('countup2', 0, parseInt(chart.sqftString), 0, 2.5, options);
        c2.start();
      }
      if(flags[2]) {
        var yearOption = options;
        yearOption.separator = '';
        var c3 = new CountUp('countup3', 0, parseInt(chart.yearBuiltString), 0, 2.5, yearOption);
        c3.start();
      }
    }, 20);
  }

}])

.factory('Charts', function () {

  var runDrawBar = false;
  var runDrawPie = false;
  var demographicsObj = {};
  var barChartObj = {};
  var pieChartObj = {};
  var barChartArr = [[],[]];


  //----------------------------------------------------------------------------------
  // Clears Chart data before new neighborhood searches
  var clearCharts = function() {
    runDrawBar = false;
    runDrawPie = false;
    demographicsObj = {};
    barChartObj = {};
    pieChartObj = {};
    barChartArr = [[],[]];
  }

  //----------------------------------------------------------------------------------
  // Compiles, validates, and maps data for a bar graph from the GeoData Demography data
  // Includes data for % of homes with children
  let childData = function(demogObj, name) {

    if (!demogObj.OccupiedHousingUnits || !demogObj.HouseholdsWithIndividualsUnder18) {
      consle.log("No child data in ", name);
      return;
    }

    barChartObj.nationalHomesWithKids = 31;  // U.S. national data, 2010

    barChartObj.homesWithKids = Math.round(100 * demogObj.HouseholdsWithIndividualsUnder18 / demogObj.OccupiedHousingUnits); 

    barChartArr[0].push(barChartObj.nationalHomesWithKids);
    barChartArr[1].push(barChartObj.homesWithKids);

    runDrawBar = true;
    console.log("kid ratio:", barChartObj.homesWithKids);

  }

  //----------------------------------------------------------------------------------
  // Compiles, validates, and maps data for a bar graph from the GeoData Demography data
  // Includes data for median household income;
  let incomeData = function(demogObj, name) {

    if (!demogObj.IncomePerHousehold) {
      consle.log("No median age data in ", name);
      return;
    }

    demographicsObj.income = demogObj.IncomePerHousehold
  }


  //----------------------------------------------------------------------------------
  // Compiles, validates, and maps data for a bar graph from the GeoData Demography data
  // Includes data for median age;
  let ageData = function(demogObj, name) {

    if (!demogObj.MedianAge) {
      consle.log("No median age data in ", name);
      return;
    }

    demographicsObj.age = demogObj.MedianAge;
  }

  //----------------------------------------------------------------------------------
  // Compiles, validates, and maps data for a bar graph from the GeoData Demography data
  // Includes data for median age;
  let housePopulationData = function(demogObj, name) {

    if (!demogObj.PersonsPerHousehold) {
      consle.log("No household population data in ", name);
      return;
    }

    demographicsObj.householdPop = demogObj.PersonsPerHousehold;
  }

  //----------------------------------------------------------------------------------
  // Compiles, validates, and maps data for a bar graph from the GeoData Demography data
  // Includes data for college graduation;
  let bachelorData = function(demogObj, name) {

    if (!demogObj.EducationBachelorOrGreater) {
      consle.log("No Education data in ", name);
      return;
    }

    barChartObj.bachelorDegree = Math.round(100 * demogObj.EducationBachelorOrGreater);

    barChartArr[0].push(barChartObj.nationalBachelorDegree);
    barChartArr[1].push(barChartObj.bachelorDegree);

    runDrawBar = true;
  }

  //----------------------------------------------------------------------------------
  // Compiles, validates, and maps data for a bar graph from the GeoData Demography data
  // Includes data for household family composition;
  let nonFamilyData = function(demogObj, name) {

    if (!demogObj.NonFamilyHouseholds || !demogObj.OccupiedHousingUnits) {
      consle.log("No household data in ", name);
      return;
    }

    barChartObj.nonFamilyHouseholds = Math.round(100 * demogObj.NonFamilyHouseholds / demogObj.OccupiedHousingUnits);

    barChartArr[0].push(barChartObj.nationalNonFamilyHouseholds);
    barChartArr[1].push(barChartObj.nonFamilyHouseholds);

    runDrawBar = true;

  }

  //----------------------------------------------------------------------------------
  // Compiles, validates, and maps data for a bar graph from the Zillow Demography data
  // Includes data for % of homes with children, % of owners (vs renters) and % of single people in each neighborhood

  var barChartData = function(obj) {
    runDrawBar = false;
    barChartArr = [[],[]];

    //initializing data that is constant for all neighborhoods
    barChartObj = {
      name: obj.name,
      nationalHomesWithKids: 31, // %
      nationalMedianHouseholdIncome: 44512,  //$
      natinalPersonsPerHousehold: 2.58,  //people
      nationalMedianAge: 37.2,  // years
      nationalBachelorDegree: 33, // %
      nationalNonFamilyHouseholds: 34// %, 39,177,996/116,716,292
    };  // U.S. national data, 2010

    if (obj.demography) {
      childData(obj.demography, obj.name);
      ageData(obj.demography, obj.name);
      bachelorData(obj.demography, obj.name);
      incomeData(obj.demography, obj.name);
      housePopulationData(obj.demography, obj.name);
      nonFamilyData(obj.demography, obj.name)
      console.log("Finished data mapping")
    }
    return; 




  //   //initializing data that is constant for all neighborhoods
  //   var runOwn = true;
  //   var runKids = true;
  //   var runSingles = true;
  //   barChartObj.name = obj.name;

  //   //verifing data is coming from zillow setting up basePath
  //   if (obj &&
  //   obj.demography &&
  //   obj.demography.pages &&
  //   obj.demography.pages[0] &&
  //   obj.demography.pages[0].page) {
  //     var basePath = obj.demography.pages[0].page;

  //     //-----------------------------------------------------------------------------------------------
  //     //verifying data for homes with kids
  //     if (basePath[2] &&
  //     basePath[2].tables &&
  //     basePath[2].tables[0] &&
  //     basePath[2].tables[0].table &&
  //     basePath[2].tables[0].table[0] &&
  //     basePath[2].tables[0].table[0].data &&
  //     basePath[2].tables[0].table[0].data[0] &&
  //     basePath[2].tables[0].table[0].data[0].attribute &&
  //     basePath[2].tables[0].table[0].data[0].attribute[4] &&
  //     basePath[2].tables[0].table[0].data[0].attribute[4].values &&
  //     basePath[2].tables[0].table[0].data[0].attribute[4].values[0]) {
  //       var kidPath = basePath[2].tables[0].table[0].data[0].attribute[4].values[0];
  //       //if there is neighborhood specific data from zillow for that neighborhood
  //       if (kidPath.neighborhood && kidPath.neighborhood[0] && kidPath.neighborhood[0].value && kidPath.neighborhood[0].value[0]) {
  //         barChartObj.homesWithKids = Math.round(100*parseFloat(kidPath.neighborhood[0].value[0]._));
  //       //if not use that city data from zillow for that neighborhood
  //       } else if (kidPath.city && kidPath.city[0] && kidPath.city[0].value && kidPath.city[0].value[0]) {
  //         barChartObj.homesWithKids = Math.round(100*parseFloat(kidPath.city[0].value[0]._));
  //       } else {
  //       //if neither is available don't run that portion of the bar chart
  //         runKids = false;
  //       }
  //     }

  //     //-----------------------------------------------------------------------------------------------
  //     //verifying data for home owners
  //     if (basePath[1] &&
  //     basePath[1].tables &&
  //     basePath[1].tables[0] &&
  //     basePath[1].tables[0].table &&
  //     basePath[1].tables[0].table[0] &&
  //     basePath[1].tables[0].table[0].data &&
  //     basePath[1].tables[0].table[0].data[0] &&
  //     basePath[1].tables[0].table[0].data[0].attribute &&
  //     basePath[1].tables[0].table[0].data[0].attribute[0] &&
  //     basePath[1].tables[0].table[0].data[0].attribute[0].values &&
  //     basePath[1].tables[0].table[0].data[0].attribute[0].values[0]) {
  //       var ownPath = basePath[1].tables[0].table[0].data[0].attribute[0].values[0];
  //       //percentage of property owners (vs. renters)
  //       //if there is neighborhood specific data from zillow for that neighborhood, if not use city data
  //       if (ownPath.neighborhood && ownPath.neighborhood[0] && ownPath.neighborhood[0].value && ownPath.neighborhood[0].value[0] && ownPath.neighborhood[0].value[0]._) {
  //         barChartObj.owners = Math.round(100*parseFloat(ownPath.neighborhood[0].value[0]._));
  //       } else if (ownPath.city && ownPath.city[0] && ownPath.city[0].value && ownPath.city[0].value[0] && ownPath.city[0].value[0]._) {
  //         barChartObj.owners = Math.round(100*parseFloat(ownPath.city[0].value[0]._));
  //       } else {
  //         runOwn = false;
  //       }
  //     }

  //     //-----------------------------------------------------------------------------------------------
  //     // verifying data for singles
  //     // men
  //     if (basePath[2].tables[0].table[0].data[0].attribute[1] &&
  //     basePath[2].tables[0].table[0].data[0].attribute[1].values &&
  //     basePath[2].tables[0].table[0].data[0].attribute[1].values[0] &&
  //     //women
  //     basePath[2].tables[0].table[0].data[0].attribute[2] &&
  //     basePath[2].tables[0].table[0].data[0].attribute[2].values &&
  //     basePath[2].tables[0].table[0].data[0].attribute[2].values[0]) {

  //       var menPath = basePath[2].tables[0].table[0].data[0].attribute[1].values[0];
  //       var womenPath = basePath[2].tables[0].table[0].data[0].attribute[2].values[0];

  //       //if there is neighborhood specific data from zillow for that neighborhood, if not use city data
  //       if (menPath.neighborhood && menPath.neighborhood[0] && menPath.neighborhood[0].value && menPath.neighborhood[0].value[0] && menPath.neighborhood[0].value[0]._ &&
  //       womenPath.neighborhood && womenPath.neighborhood[0] && womenPath.neighborhood[0].value && womenPath.neighborhood[0].value[0] && womenPath.neighborhood[0].value[0]._) {
  //         barChartObj.singles = Math.round(100*(parseFloat(menPath.neighborhood[0].value[0]._) + parseFloat(womenPath.neighborhood[0].value[0]._)));
  //       } else if (menPath.city && menPath.city[0] && menPath.city[0].value && menPath.city[0].value[0] && menPath.city[0].value[0]._ &&
  //       womenPath.city && womenPath.city[0] && womenPath.city[0].value && womenPath.city[0].value[0] && womenPath.city[0].value[0]._) {
  //         barChartObj.singles = Math.round(100*(parseFloat(menPath.city[0].value[0]._) + parseFloat(womenPath.city[0].value[0]._)));
  //       } else {
  //         runSingles = false;
  //       }
  //     }

  //     //----------------------------------------------------------------------------------------------
  //     // populating demographicsObj.income with median household income from zillow

  //     if (basePath[2].tables[0].table[0].data[0].attribute[0] &&
  //     basePath[2].tables[0].table[0].data[0].attribute[0].values &&
  //     basePath[2].tables[0].table[0].data[0].attribute[0].values[0]) {
  //       var incomePath = basePath[2].tables[0].table[0].data[0].attribute[0].values[0];

  //     //if there is neighborhood specific data from zillow for that neighborhood, if not use city data
  //       if (incomePath.neighborhood && incomePath.neighborhood[0].value && incomePath.neighborhood[0].value[0]) {
  //         demographicsObj.income = incomePath.neighborhood[0].value[0]._;
  //       } else if (incomePath.city && incomePath.city[0].value && incomePath.city[0].value[0]) {
  //         demographicsObj.income = incomePath.city[0].value[0]._;
  //       }
  //     }

  //     //----------------------------------------------------------------------------------------------
  //     // populating demographicsObj.income with ave square foot size of houses for the neighborhood or city

  //     if (basePath[1].tables[0].table[0].data[0].attribute[2] &&
  //     basePath[1].tables[0].table[0].data[0].attribute[2].values &&
  //     basePath[1].tables[0].table[0].data[0].attribute[2].values[0] ){
  //       var sqftPath = basePath[1].tables[0].table[0].data[0].attribute[2].values[0];
  //       //if there is neighborhood specific data from zillow for that neighborhood, if not use city data
  //       if (sqftPath.neighborhood && sqftPath.neighborhood[0].value[0]) {
  //         demographicsObj.sqft = sqftPath.neighborhood[0].value[0];
  //       } else if (sqftPath.city && sqftPath.city[0].value[0]) {
  //         demographicsObj.sqft = sqftPath.city[0].value[0];
  //       }
  //     }

  //     //----------------------------------------------------------------------------------------------
  //     // populating demographicsObj.income with ave year built for the neighborhood or city

  //     if (basePath[1].tables[0].table[0].data[0].attribute[3] &&
  //     basePath[1].tables[0].table[0].data[0].attribute[3].values &&
  //     basePath[1].tables[0].table[0].data[0].attribute[3].values[0]){
  //       var yearBuiltPath = basePath[1].tables[0].table[0].data[0].attribute[3].values[0];
  //       //if there is neighborhood specific data from zillow for that neighborhood, if not use city data
  //       if (yearBuiltPath.neighborhood && yearBuiltPath.neighborhood[0].value[0]) {
  //         demographicsObj.yearBuilt = yearBuiltPath.neighborhood[0].value[0];
  //       } else if (yearBuiltPath.city && yearBuiltPath.city[0].value[0]) {
  //         demographicsObj.yearBuilt = yearBuiltPath.city[0].value[0];
  //       }
  //     }

  //   //if none of the basePath is coming in, none of the bar charts should run
  //   } else {
  //     runKids = false;
  //     runOwn = false;
  //     runSingles = false;
  //   }
  //   //if at least one of the charts has the information to run, run the chart
  //   if (runOwn || runKids || runSingles) {
  //     runDrawBar = true;
  //   }

  //   //sets up the bar chart data in the array format that draws the bar chart
  //   if (runKids) {
  //     barChartArr[0].push(barChartObj.nationalHomesWithKids);
  //     barChartArr[1].push(barChartObj.homesWithKids);
  //   }

  //   if (runOwn) {
  //     barChartArr[0].push(barChartObj.nationalOwners);
  //     barChartArr[1].push(barChartObj.owners);
  //   }

  //   if (runSingles) {
  //     barChartArr[0].push(barChartObj.nationalSingles);
  //     barChartArr[1].push(barChartObj.singles);
  //   }
  };

  //----------------------------------------------------------------------------------
  // Draws the bar chart , only drawing columns when data is available for that subject.

  var drawBar = function() {
    // runDrawBar = true; //remove this line when doing the API calls see **
    console.log("barChartArr", barChartArr)
    console.log("barChartObj", barChartObj)
    if (runDrawBar){
      $('#percentage-chart').highcharts({
        chart: {
            type: 'column'
        },
        exporting: { enabled: false },
        title: {
            text: barChartObj.name + ' Compared To Nation'
        },
        xAxis: {
            categories: [
                'Households with Kids',
                "Adults with Bachelor's Degrees",
                'Non-Family Households'
            ]
        },
        yAxis: [{
            min: 0,
            max: 100,
            title: {
                text: 'Percentage'
            }
        }],
        legend: {
            shadow: false
        },
        tooltip: {
            shared: true
        },
        plotOptions: {
            column: {
                grouping: false,
                shadow: false,
                borderWidth: 0
            }
        },
        series: [{
            name: 'Nation',
            color: '#CAE0A8',
            data: barChartArr[0],
            // data: [50, 10, 60], //**comment this in and uncomment the previous line to not do API calls
            pointPadding: 0,
            pointPlacement: 0
        }, {
            name: barChartObj.name,
            color: '#3878C7',
            data: barChartArr[1],
            // data: [40, 20, 30], //**comment this in and uncomment the previous line to not do API calls
            pointPadding: 0.2,
            pointPlacement: 0
        }]
      });
    }
  };

  //----------------------------------------------------------------------------------
  // Compiles, validates, and maps data for a pie chart of age distributions in each neighborhood from the Zillow Demography data

  var pieChartData = function(obj) {
    pieChartObj = {};
    runDrawPie = false;
    //verifying information is coming in from zillow
    if (obj &&
        obj.demography &&
        obj.demography.pages &&
        obj.demography.pages[0] &&
        obj.demography.pages[0].page &&
        obj.demography.pages[0].page[2] &&
        obj.demography.pages[0].page[2].tables &&
        obj.demography.pages[0].page[2].tables[0] &&
        obj.demography.pages[0].page[2].tables[0].table &&
        obj.demography.pages[0].page[2].tables[0].table[1] &&
        obj.demography.pages[0].page[2].tables[0].table[1].data &&
        obj.demography.pages[0].page[2].tables[0].table[1].data[0] &&
        obj.demography.pages[0].page[2].tables[0].table[1].data[0].attribute)
    {
      var agePath = obj.demography.pages[0].page[2].tables[0].table[1].data[0].attribute

      //checks each age range for data from zillow
      if (agePath[0] && agePath[0].value && agePath[0].value[0] && agePath[0].value[0]._) {
        pieChartObj['70+ years'] = Math.round(100 * parseFloat(agePath[0].value[0]._));
      }
      if (agePath[7] && agePath[7].value && agePath[7].value[0] && agePath[7].value[0]._) {
        pieChartObj['60-70 years'] = Math.round(100 * parseFloat(agePath[7].value[0]._));
      }
      if (agePath[6] && agePath[6].value && agePath[6].value[0] && agePath[6].value[0]._) {
        pieChartObj['50-60 years'] = Math.round(100 * parseFloat(agePath[6].value[0]._));
      }
      if (agePath[5] && agePath[5].value && agePath[5].value[0] && agePath[5].value[0]._) {
        pieChartObj['40-50 years'] = Math.round(100 * parseFloat(agePath[5].value[0]._));
      }
      if (agePath[4] && agePath[4].value && agePath[4].value[0] && agePath[4].value[0]._) {
        pieChartObj['30-40 years'] = Math.round(100 * parseFloat(agePath[4].value[0]._));
      }
      if (agePath[3] && agePath[3].value && agePath[3].value[0] && agePath[3].value[0]._) {
        pieChartObj['20-30 years'] = Math.round(100 * parseFloat(agePath[3].value[0]._));
      }
      if (agePath[2] && agePath[2].value && agePath[2].value[0] && agePath[2].value[0]._) {
        pieChartObj['10-20 years'] = Math.round(100 * parseFloat(agePath[2].value[0]._));
      }
      if (agePath[1] && agePath[1].value && agePath[1].value[0] && agePath[1].value[0]._) {
        pieChartObj['0-10 years'] = Math.round(100 * parseFloat(agePath[1].value[0]._));
      }
    }
    //only draws the pie chart if each age range has a value
    if (pieChartObj['0-10 years'] && pieChartObj['10-20 years'] && pieChartObj['20-30 years'] && pieChartObj['30-40 years'] &&
        pieChartObj['40-50 years'] && pieChartObj['50-60 years'] && pieChartObj['60-70 years'] && pieChartObj['70+ years']) {
        runDrawPie = true;
    }
  };

  //----------------------------------------------------------------------------------
  // Draws the Pie chart for age distribution in a given neighborhood


  var drawPie = function() {
    //runDrawPie = true; //uncomment this for testing without calling the APIs see **
    if (runDrawPie) {

      Highcharts.setOptions({
       colors: ['#FA9E25','#A5AAD9', '#FFC735', '#FF7D70', '#CAE0A8', '#5F347C', '#B2D0FF', '#3878C7'],
        chart: {
          style: {
            fontFamily: 'AvenirNextPro'
         }
        }
      });

      $('#pie-chart').highcharts({
          chart: {
              type: 'pie'
          },
          title: {
            text:   "Resident Age Distribution"
          },
          exporting: { enabled: false },
          plotOptions: {
              pie: {
                  borderWidth: 2
                  //uncomment to remove the line labels and just use the pie chart legend
                  // showInLegend: true,
                  // dataLabels: {
                  //   enabled: false
                  // }
              },

          },
          series: [{
            data: [
              ['0-10 years old',    pieChartObj['0-10 years']],
              ['10-20 years old',    pieChartObj['10-20 years']],
              ['20-30 years old',    pieChartObj['20-30 years']],
              ['30-40 years old',    pieChartObj['30-40 years']],
              ['40-50 years old',    pieChartObj['40-50 years']],
              ['50-60 years old',    pieChartObj['50-60 years']],
              ['60-70 years old',    pieChartObj['60-70 years']],
              ['70+ years old',    pieChartObj['70+ years']]

              //**test data comment back in and remove preceeding section
              // ['0-10 years old', 5],
              // ['10-20 years old', 10],
              // ['20-30 years old', 15],
              // ['30-40 years old', 32],
              // ['40-50 years old', 32],
              // ['50-60 years old', 32],
              // ['60-70 years old', 32],
              // ['70+ years old', 32]
            ]
          }]
      });
    }
  };

  var createStrings = function () {
    if (!!demographicsObj.income) {
      demographicsObj.incomeString = parseInt(demographicsObj.income);
    }
    if (!!demographicsObj.age) {
      demographicsObj.ageString = parseInt(demographicsObj.age);
    }
    if (!!demographicsObj.householdPop) {
      demographicsObj.householdPopString = demographicsObj.householdPop.toString();
    }
  };

  var getDemographicsObj = function () {
    return demographicsObj;
  }

  var getFlags = function () {
    return [runDrawBar, runDrawPie];
  }

  return {
    drawBar: drawBar,
    drawPie: drawPie,
    barChartData: barChartData,
    pieChartData: pieChartData,
    getDemographicsObj: getDemographicsObj,
    demographicsObj: demographicsObj,
    clearCharts: clearCharts,
    createStrings: createStrings,
    getFlags: getFlags
  };

});

angular.module('myApp.charts')
.directive('charts', ['Charts', '$timeout', function(Charts, $timeout) {
  return {
    restrict: 'E',
    replace: true,
    templateUrl: 'app/charts/chartsTemplate.html',
    link: function() {
      $timeout( function(){
        Charts.drawBar();
        Charts.drawPie();
      }, 0);
    }
  };
}]);

var CountUp=function(a,b,c,d,e,f){for(var g=0,h=["webkit","moz","ms","o"],i=0;i<h.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[h[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[h[i]+"CancelAnimationFrame"]||window[h[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a){var c=(new Date).getTime(),d=Math.max(0,16-(c-g)),e=window.setTimeout(function(){a(c+d)},d);return g=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)}),this.options={useEasing:!0,useGrouping:!0,separator:",",decimal:"."};for(var j in f)f.hasOwnProperty(j)&&(this.options[j]=f[j]);""===this.options.separator&&(this.options.useGrouping=!1),this.options.prefix||(this.options.prefix=""),this.options.suffix||(this.options.suffix=""),this.d="string"==typeof a?document.getElementById(a):a,this.startVal=Number(b),isNaN(b)&&(this.startVal=Number(b.match(/[\d]+/g).join(""))),this.endVal=Number(c),isNaN(c)&&(this.endVal=Number(c.match(/[\d]+/g).join(""))),this.countDown=this.startVal>this.endVal,this.frameVal=this.startVal,this.decimals=Math.max(0,d||0),this.dec=Math.pow(10,this.decimals),this.duration=1e3*Number(e)||2e3;var k=this;this.version=function(){return"1.5.3"},this.printValue=function(a){var b=isNaN(a)?"--":k.formatNumber(a);"INPUT"==k.d.tagName?this.d.value=b:"text"==k.d.tagName?this.d.textContent=b:this.d.innerHTML=b},this.easeOutExpo=function(a,b,c,d){return 1024*c*(-Math.pow(2,-10*a/d)+1)/1023+b},this.count=function(a){k.startTime||(k.startTime=a),k.timestamp=a;var b=a-k.startTime;k.remaining=k.duration-b,k.frameVal=k.options.useEasing?k.countDown?k.startVal-k.easeOutExpo(b,0,k.startVal-k.endVal,k.duration):k.easeOutExpo(b,k.startVal,k.endVal-k.startVal,k.duration):k.countDown?k.startVal-(k.startVal-k.endVal)*(b/k.duration):k.startVal+(k.endVal-k.startVal)*(b/k.duration),k.frameVal=k.countDown?k.frameVal<k.endVal?k.endVal:k.frameVal:k.frameVal>k.endVal?k.endVal:k.frameVal,k.frameVal=Math.round(k.frameVal*k.dec)/k.dec,k.printValue(k.frameVal),b<k.duration?k.rAF=requestAnimationFrame(k.count):k.callback&&k.callback()},this.start=function(a){return k.callback=a,isNaN(k.endVal)||isNaN(k.startVal)||k.startVal===k.endVal?(console.log("countUp error: startVal or endVal is not a number"),k.printValue(c)):k.rAF=requestAnimationFrame(k.count),!1},this.pauseResume=function(){k.paused?(k.paused=!1,delete k.startTime,k.duration=k.remaining,k.startVal=k.frameVal,requestAnimationFrame(k.count)):(k.paused=!0,cancelAnimationFrame(k.rAF))},this.reset=function(){k.paused=!1,delete k.startTime,k.startVal=b,cancelAnimationFrame(k.rAF),k.printValue(k.startVal)},this.update=function(a){cancelAnimationFrame(k.rAF),k.paused=!1,delete k.startTime,k.startVal=k.frameVal,k.endVal=Number(a),k.countDown=k.startVal>k.endVal,k.rAF=requestAnimationFrame(k.count)},this.formatNumber=function(a){a=a.toFixed(k.decimals),a+="";var b,c,d,e;if(b=a.split("."),c=b[0],d=b.length>1?k.options.decimal+b[1]:"",e=/(\d+)(\d{3})/,k.options.useGrouping)for(;e.test(c);)c=c.replace(e,"$1"+k.options.separator+"$2");return k.options.prefix+c+d+k.options.suffix},k.printValue(k.startVal)};
var team = angular.module('myApp.team', []);

team.directive('team', [function() {
  return {
    restrict: 'E',
    replace: true,
    templateUrl: 'app/team/teamTemplate.html'
  };
}]);
